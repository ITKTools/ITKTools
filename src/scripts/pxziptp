#!/bin/bash

helpneeded="false"

if [ $# = 0 ]
then
  helpneeded="true"
fi

if [ "$1" = "-h" ]
then
  helpneeded="true"
fi


if [ "$1" = "--help" ]
then
  helpneeded="true"
fi

if [ "$1" = "--h" ]
then
  helpneeded="true"
fi


if [ "$1" = "-d" ]
then
  indir=$2
else
	helpneeded="true"
fi


if [ "$helpneeded" = "true" ]
then
echo
echo "pxziptp script"
echo
echo "The TransformParameter-files generated by elastix and the TransformixOutput directories"
echo "generated by Transformices are archived in a file called TransformParametersArchive.tgz"
echo 
echo "Usage:"
echo
echo "pxziptp -d <dir>"
echo
exit 64
fi


cd $indir
indirabs=`pwd`
tparchive="TransformParametersArchive.tgz"
ziptpbusy="ziptpbusy.txt"

if [ -e $tparchive ]
then
	echo "The following archive already exists:"
	echo "  $indir/$tparchive"
	echo "Zipping is skipped"
	exit 66
fi

if [ -e $ziptpbusy ]
then
  echo "A $ziptpbusy-file has been found in $indir."
  echo "This probably means that px(un)ziptp is already running in this directory, or that something unexpected happened in a previous run of px(un)ziptp!"
  cd $nowdir
  exit 65
fi

# create a lock file and initialise the tparchive
> $ziptpbusy
> $tparchive

echo
echo "The following directory will be processed by ziptp: $indir"
echo

# exclude some files
ls -1 -I 'TransformParameters.?.R?.It*' -I 'TransformixOutput.?.R?.It*' -I $ziptpbusy >> $ziptpbusy

# zip!
tar -cjf $tparchive --exclude-from $ziptpbusy --exclude $tparchive --exclude $ziptpbusy --remove-files .

#remove dirs
rm -Rf TransformixOutput.?.R?.It*

rm $ziptpbusy

cd $nowdir
echo "Ready!"

exit 0

