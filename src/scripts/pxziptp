#!/bin/bash

helpneeded="false"

if [ $# = 0 ]
then
  helpneeded="true"
fi

if [ "$1" = "-h" ]
then
  helpneeded="true"
fi


if [ "$1" = "--help" ]
then
  helpneeded="true"
fi

if [ "$1" = "--h" ]
then
  helpneeded="true"
fi


if [ "$1" = "-d" ]
then
  indir=$2
  if [ "$indir" = "." ]
  then 
  helpneeded="true"
  fi
 else
	helpneeded="true"
fi


if [ "$helpneeded" = "true" ]
then
echo
echo "ziptp script"
echo
echo "The TransformParameter-files generated by elastix and the TransformixOutput directories"
echo "generated by Transformices are archived in a file called TransformParametersArchive.tgz"
echo 
echo "Usage:"
echo
echo "ziptp -d <dir>"
echo
echo "<dir> is not allowed to be the current directory (.)"
echo
exit 64
fi


cd $indir
indirabs=`pwd`
tparchive="TransformParametersArchive.tgz"
ziptpbusy="ziptpbusy.txt"
tempdirname="../pxziptptempdir"


if [ -e $ziptpbusy ]
then
  echo "A $ziptpbusy-file has been found in $indir."
  echo "This probably means that ziptp is already running in this directory, or that something unexpected happened in a previous run of ziptp!"
  cd $nowdir
  exit 65
fi

if [ -e $tparchive ]
then
	echo "The following archive already exists:"
	echo "  $tparchive"
	echo "Zipping is skipped"
	exit 66
fi

echo
echo "The following directory will be processed by ziptp: $indir"
echo

# create a non-empty archive
> $ziptpbusy

niet=`ls -1 -I 'TransformParameters.?.R?.It*' -I 'TransformixOutput.?.R?.It*' -I $ziptpbusy`

if [ -e $tempdirname ]
then
	echo "$tempdirname already exists!"
	exit 67
fi

mkdir $tempdirname
mv $niet $tempdirname
cp $ziptpbusy $tempdirname/$ziptpbusy

> $tparchive
tar -cjf $tparchive --exclude $tparchive --exclude $ziptpbusy --remove-files .

#remove dirs
#mv $tparchive $tempdirname
rm -R TransformixOutput.?.R?.It*

mv $tempdirname/* .

# used to work like this:
#cd $tempdirname
#rm -R $indirabs
#mkdir $indirabs
#mv * $indirabs
#cd $indirabs

rm -R $tempdirname
rm $ziptpbusy

cd $nowdir
echo "Ready!"

exit 0

