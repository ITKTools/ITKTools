#!/bin/bash

helpneeded="false"

if [ $# = 0 ]
then
  helpneeded="true"
fi

if [ "$1" = "-h" ]
then
  helpneeded="true"
fi


if [ "$1" = "--help" ]
then
  helpneeded="true"
fi

if [ "$1" = "--h" ]
then
  helpneeded="true"
fi


if [ "$1" = "-d" ]
then
  indir=$2
 else
	helpneeded="true"
fi

if [ "$helpneeded" = "true" ]
then
echo
echo "ziptp script"
echo
echo "The TransformParameter-files generated by elastix and the TransformixOutput directories"
echo "generated by Transformices are archived in a file called TransformParametersArchive.tar.gz"
echo 
echo "Usage:"
echo
echo "ziptp -d <dir>"
echo
exit 64
fi

cd $indir
nr0_9="0 1 2 3 4 5 6 7 8 9"
tparchive="TransformParametersArchive.tar"
ziptpbusy="ziptpbusy.txt"

if [ -e $ziptpbusy ]
then
  echo "A $ziptpbusy-file has been found in $indir."
  echo "This probably means that ziptp is already running in this directory, or that something unexpected happened in a previous run of ziptp!"
  cd $nowdir
  exit 65
fi

echo
echo "The following directory will be processed by ziptp: $indir"
echo

# create a non-empty archive
> $ziptpbusy
tar -cf $tparchive $ziptpbusy

for E in $nr0_9
do
  for R in $nr0_9
  do
    for It0 in $nr0_9
    do
      for It1 in $nr0_9
      do
        for It2 in $nr0_9
	do
	  for It3 in $nr0_9
	  do
	    for It4 in $nr0_9
	    do
	      for It5 in $nr0_9
	      do
	        for It6 in $nr0_9
		do
		  It="$It0$It1$It2$It3$It4$It5$It6"
			tp_file="TransformParameters.$E.R$R.It$It.txt"
		  tp_dir="TransformixOutput.$E.R$R.It$It"

		  if [ ! -e $tp_file ]
		  then
		    #last iteration of this resolution; go to next resolution
		    break 7
		  fi

			echo "adding $indir/$tp_file to $indir/$tparchive"
			tar -rf $tparchive $tp_file
			zitintar=""
			zitintar=`tar -tf $tparchive | grep $tp_file`
			rm $zitintar
			
			if [ -e $tp_dir ]
			then
				echo "adding $indir/$tp_dir to $indir/$tparchive"
				tar -rf $tparchive $tp_dir
				zitintar=""
				zitintar=`tar -tf $tparchive | grep $tp_dir`
				if [ -n "$zitintar" ]
				then
					rm -R $tp_dir
				fi
			fi
		  
		done
	      done
	    done
	  done
	done
      done
    done
  done
done

tar --delete $ziptpbusy -f $tparchive

echo "Compressing $indir/$tparchive to $indir/$tparchive.gz"
gzip -9 $tparchive

rm $ziptpbusy

cd $nowdir
echo "Ready!"

exit 0

